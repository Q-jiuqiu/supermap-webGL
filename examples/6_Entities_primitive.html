<!--
 * @Author: quling
 * @Date: 2023-11-09 21:20:14
 * @LastEditors: quling
 * @LastEditTime: 2023-12-21 11:31:19
 * @Description: 
 * @FilePath: \supermap-webGL\examples\6_Entities_primitive.html
-->
<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>捕获entity\primitive</title>
  <link href="../lib/Build/SuperMap3D/Widgets/widgets.css" rel="stylesheet">
  <link rel="stylesheet" href="../lib/css/pretty.css">
  <link rel="stylesheet" href="../lib/css/bootstrap.min.css">
  <script type="text/javascript" src="../lib/js/tooltip.js"></script>
  <script type="text/javascript" src="../lib/js/jquery.min.js"></script>
  <script type="text/javascript" src="../lib/Build/SuperMap3D/SuperMap3D.js"></script>
  <script type="text/javascript" src="../lib/js/config.js"></script>
  <style>
    body {
      position: relative;

    }

    .operation {
      position: absolute;
      top: 0;
      left: 0;
      z-index: 1;
    }

    #Container {
      background-size: cover;
      width: 100%;
      height: 100%;
    }

    /* 设置光标样式 */
    .drawCur {
      cursor: url("../assets/cur/draw.cur"), auto !important;
    }
  </style>
</head>

<body>
  <div class="operation">
    <button id="line" class="button black">绘制线</button>
  </div>
  <div id="Container"></div>

  <script type="text/javascript">
    let viewer = null
    let scene = null
    let camera = null
    let tooltip = null

    function onload(SuperMap3D) {
      viewer = new SuperMap3D.Viewer('Container', {
        // 取消信息提示框
        infoBox: false,
      });
      scene = viewer.scene;
      camera = viewer.camera;
      tooltip = createTooltip(document.body);

      // 取消深度测试  - 如果布告板/折线/标签等针对地形表面开启深度检测，则不会被遮挡。
      scene.globe.depthTestAgainstTerrain = false;
    }
    onload(SuperMap3D);

    // function computeCircle(radius) {
    //   // 计算一个圆形的顶点位置
    //   var positions = [];
    //   // 180 半圆 / 360 整圆
    //   for (var i = 0; i < 180; i++) {
    //     var radians = SuperMap3D.Math.toRadians(i);
    //     positions.push(new SuperMap3D.Cartesian2(radius * Math.cos(radians), radius * Math.sin(radians)));
    //   }
    //   return positions;
    // }

    // // 多段线柱体对象
    // viewer.entities.add({
    //   id: "polylineVolume1",
    //   polylineVolume: {
    //     positions: SuperMap3D.Cartesian3.fromDegreesArray([117.0, 32.0, 120.0, 36.0, 130.0, 36.0]),
    //     material: SuperMap3D.Color.YELLOW,
    //     shape: computeCircle(6000.0),
    //   }

    // });

    // viewer.flyTo(viewer.entities);

    // // 添加primitive对象
    // const instance = new SuperMap3D.GeometryInstance({
    //   geometry: new SuperMap3D.EllipseGeometry({
    //     center: SuperMap3D.Cartesian3.fromDegrees(117.0, 32.0),
    //     semiMinorAxis: 500000.0,
    //     semiMajorAxis: 1000000.0,
    //     rotation: SuperMap3D.Math.PI_OVER_FOUR,
    //     vertexFormat: SuperMap3D.VertexFormat.POSITION_AND_ST
    //   }),
    //   id: 'primitive'
    // });

    // const ellipsePrimitive = new SuperMap3D.Primitive({
    //   geometryInstances: instance,
    //   appearance: new SuperMap3D.EllipsoidSurfaceAppearance({
    //     material: SuperMap3D.Material.fromType('Checkerboard')
    //   })
    // })
    // scene.primitives.add(ellipsePrimitive)

    let entity = null
    $("#line").click(() => {
      const positions = []
      let poly = null
      $(".supermap3d-viewer").addClass("drawCur")

      let handler = new SuperMap3D.ScreenSpaceEventHandler(viewer.canvas)
      // 线entity
      const polyLineEntity = (function () {
        function _(positions) {
          // polyline 配置
          this.options = {
            name: 'polyline',
            polyline: {
              show: true,
              positions: [],
              material: SuperMap3D.Color.GREEN,
              width: 3
            }
          }
          this.positions = positions;
          this._init();
        }

        _.prototype._init = function () {
          let _self = this;
          this.options.polyline.positions = new SuperMap3D.CallbackProperty(function () {
            return _self.positions;
          }, false);
          entity = viewer.entities.add(this.options);
        }
        return _;
      })()

      poly = new polyLineEntity(positions);

      // 监听鼠标左键事件-绘制点
      handler.setInputAction((movement) => {
        // 将屏幕坐标转化为笛卡尔坐标
        const cartesian = viewer.scene.pickPosition(movement.position);
        positions.push(cartesian)

      }, SuperMap3D.ScreenSpaceEventType.LEFT_CLICK)

      // 监听鼠标移动事件,添加提示框
      handler.setInputAction((movement) => {
        // 鼠标移动结束屏幕位置
        const { endPosition } = movement
        tooltip.showAt(endPosition, `<p>左键点击确定折线中间点</p><p>左键双击结束绘制</p>`);
        const cartesian = viewer.scene.pickPosition(movement.endPosition);

        if (!SuperMap3D.defined(poly)) {
          poly = new polyLineEntity(positions);
        } else {
          if (cartesian != undefined) {
            positions.pop();
            positions.push(cartesian);
          }
        }
      }, SuperMap3D.ScreenSpaceEventType.MOUSE_MOVE)

      // 监听鼠标左键双键事件,结束绘制--结束监听
      handler.setInputAction((rightEvent) => {
        console.log(rightEvent, entity);
        tooltip.setVisible(false);
        // 结束handle监听,并置空
        handler = handler && handler.destroy()
        handleEdit(entity)
        $(".supermap3d-viewer").removeClass("drawCur")
      }, SuperMap3D.ScreenSpaceEventType.LEFT_DOUBLE_CLICK)
    })

    let editHandler = null;

    // 编辑
    function handleEdit(entity) {
      if (!entity) {
        editHandler && editHandler.deactivate();
        return;
      }
      if (!editHandler) {
        editHandler = new SuperMap3D.EditHandler(viewer, entity);
        // 设置线面支持编辑高度
        editHandler.isEditZ = true;
        editHandler.activate();
      } else {
        editHandler.deactivate();
        editHandler.setEditObject(entity);
        editHandler.activate();
      }
    }
  </script>
</body>

</html>