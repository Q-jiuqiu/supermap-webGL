<!--
 * @Author: quling
 * @Date: 2024-01-29 14:27:19
 * @LastEditors: quling
 * @LastEditTime: 2024-02-02 14:43:28
 * @Description: 
 * @FilePath: \supermap-webGL\examples\11_query.html
-->
<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>空间查询</title>
  <link href="../lib/Build/SuperMap3D/Widgets/widgets.css" rel="stylesheet">
  <link rel="stylesheet" href="../lib/css/pretty.css">
  <link rel="stylesheet" href="../lib/css/bootstrap.min.css">
  <script type="text/javascript" src="../lib/js/tooltip.js"></script>
  <script type="text/javascript" src="../lib/js/jquery.min.js"></script>
  <script type="text/javascript" src="../lib/Build/SuperMap3D/SuperMap3D.js"></script>
  <script type="text/javascript" src="../lib/js/config.js"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/proj4js/2.10.0/proj4.js"
    integrity="sha512-e3rsOu6v8lmVnZylXpOq3DO/UxrCgoEMqosQxGygrgHlves9HTwQzVQ/dLO+nwSbOSAecjRD7Y/c4onmiBVo6w=="
    crossorigin="anonymous" referrerpolicy="no-referrer"></script>

  <style>
    body {
      position: relative;

    }

    .operation {
      position: absolute;
      top: 0;
      left: 0;
      z-index: 1;
    }

    /* 设置光标样式 */
    .drawCur {
      cursor: url("../assets/cur/draw.cur"), auto !important;
    }
  </style>
</head>

<body>
  <div class="operation">
    <button id="addSupermap" class="button black">添加超图场景</button>
    <button id="addArcGIS" class="button black">加载Arcgis服务</button>
  </div>
  <div id="Container"></div>
</body>

<script>
  let viewer = null
  let scene = null
  let camera = null
  let drawHandler = null
  let tooltip = null

  function onload(SuperMap3D) {
    viewer = new SuperMap3D.Viewer('Container', {
      timeline: true,
      animation: true,
      shouldAnimate: true,
    })

    scene = viewer.scene
    camera = scene.camera
    tooltip = createTooltip(document.body);
  }

  onload(SuperMap3D)

  /**
   * @description: 添加超图场景
   * @param {*} 
   * @return {*}
   */
  $("#addSupermap").click(function () {
    const promise = scene.open(URL_CONFIG.SCENE_CBD, "CBD")
    $(this).attr("disabled", true);
    SuperMap3D.when(promise, (layers) => {
      console.log(layers);
      createDraw(querySupermap)
    })
  })


  /**
   * @description: 绘制
   * @return {*}
   */
  function createDraw(stopCallBack) {
    if (!drawHandler) {
      drawHandler = new SuperMap3D.DrawHandler(viewer, SuperMap3D.DrawMode.Polygon, SuperMap3D.ClampMode.Ground)

      drawHandler.activeEvt.addEventListener(function (isActive) {
        if (isActive) {
          viewer._element.style.cursor = ""
          $(".supermap3d-viewer").addClass("drawCur")
        } else {
          $(".supermap3d-viewer").removeClass("drawCur")
        }
      });

      // 监听handler移动事件,返回鼠标在屏幕的位置
      drawHandler.movingEvt.addEventListener((windowPosition) => {
        tooltip.showAt(windowPosition, `<p>点击绘制面,右击结束</p>`);
      })

      // 监听绘制是否完成,获取绘制结果
      drawHandler.drawEvt.addEventListener((result) => {
        console.log(result);
        tooltip.setVisible(false);
        const polygon = result.object
        const positions = polygon.positions // 组成面的点的笛卡尔3坐标数组
        stopCallBack && stopCallBack(positions)
      })

      drawHandler.activate();
    } else {
      drawHandler.activate();
    }
  }

  /**
   * @description: 将笛卡尔3坐标数组格式化为经纬度坐标,转为经纬度坐标数组
   * @param {Cartesian3[]} positions
   * @return {{x:Degrees,y:Degrees}[]} points
   */
  function formatDegreesData(positions) {
    return positions.map((position) => {
      const cartographic = SuperMap3D.Cartographic.fromCartesian(position)
      const x = SuperMap3D.Math.toDegrees(cartographic.longitude)
      const y = SuperMap3D.Math.toDegrees(cartographic.latitude)
      return { x, y }
    })
  }

  /**
   * @description: 超图空间服务查询
   * @param {Cartesian3[]} positions
   * @return {*}
   */
  function querySupermap(positions) {
    const points = formatDegreesData(positions)
    const queryObj = {
      // 查询模式-必选
      getFeatureMode: "SPATIAL",
      // 空间查询模式-SPATIAL、SPATIAL_ATTRIBUTEFILTER时，此参数必选-当数据类型为Geo_Point时，支持的空间查询模式仅为CONTAIN。当数据类型为Geo_Shape时，支持的空间查询模式CONTAIN、WITHIN、INTERSECT、DISJOINT。
      spatialQueryMode: "CONTAIN",
      // 待查询的数据集数组-数据集名称由数据源名和数据集名构成-必选
      datasetNames: ["二维数据:Building"],
      // 几何对象-当 getFeatureMode（查询模式）为BUFFER、BUFFER_ATTRIBUTEFILTER、SPATIAL、SPATIAL_ATTRIBUTEFILTER时，此参数必选
      geometry: {
        points,
        type: "REGION"
      }
    };
    const paramsJson = JSON.stringify(queryObj)
    console.log(queryObj);
    $.ajax({
      type: "post",
      url: "http://www.supermapol.com/realspace/services/data-cbd/rest/data/featureResults.rjson?returnContent=true",
      data: paramsJson,
      success: function (result) {
        const resultObj = JSON.parse(result);
        console.log(resultObj);
        if (resultObj.features.length > 0) {
          renderEntities(resultObj.features)
        }
      },
      error: function (msg) {
        console.log(msg);
      },
      complete: function () {
        console.log("complete");
      }
    })
  }


  /**
   * @description: 根据features绘制Entity
   * @param {*} features
   * @return {*}
   */
  function renderEntities(features) {
    viewer.entities.removeAll()
    features.forEach(feature => {
      let res = ""
      for (let j = 0; j < feature.fieldNames.length; j++) {
        const index = j.toString();
        if (j == 0) {
          des = '<table class="supermap3d-infoBox-defaultTable"><tbody>' + '<tr><th>' + feature.fieldNames["0"] + '</th><td>' + feature.fieldValues["0"] + '</td></tr>';
        } else if (j == feature.fieldNames.length - 1) {
          des += '<tr><th>' + feature.fieldNames[index] + '</th><td>' + feature.fieldValues[index] + '</td></tr>' + "</tbody></table>";
        } else {
          des += '<tr><th>' + feature.fieldNames[index] + '</th><td>' + feature.fieldValues[index] + '</td></tr>';
        }
      }
      viewer.entities.add({
        // 将经纬度高程转换为笛卡尔3
        position: SuperMap3D.Cartesian3.fromDegrees(parseFloat(feature.fieldValues["12"]), parseFloat(feature.fieldValues["13"]), parseFloat(feature.fieldValues["16"])),
        billboard: {
          image: '../assets/location4.png',
          width: 30,
          height: 40,
        },
        name: feature.fieldValues["11"],
        description: des
      })
    });
  }

  $("#addArcGIS").click(async () => {
    $(this).attr("disabled", true)

    const arcgis = new SuperMap3D.ArcGisMapServerImageryProvider({
      // url: "http://192.168.1.212:6080/arcgis/rest/services/SCYLSJ/MapServer"
      // url: "http://192.168.1.181:16080/arcgis/rest/services/LZ/LZ_GLSJ/MapServer"
      url: "http://192.168.1.68:6080/arcgis/rest/services/CZGH/CZGH/MapServer"
      // url: "https://services.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer"
    })
    const layer = await viewer.imageryLayers.addImageryProvider(arcgis)
    console.log(layer);
    camera.setView({
      // 兰州位置
      // destination: new SuperMap3D.Cartesian3(-1225994.6126557533, 5019492.465861876, 3731808.4549457263),
      // CZGH位置
      destination: new SuperMap3D.Cartesian3(-2565240.8158761165, 5020201.666434277, 3003932.5215713596),
      // 泸州位置
      // destination: new SuperMap3D.Cartesian3.fromDegrees(105.39, 28.91, 105.40531821331771),
    });
    createDraw(queryArcGis)
  })

  function queryArcGis(positions) {

    const coordinates = positions.map((position) => {
      const cartographic = SuperMap3D.Cartographic.fromCartesian(position)
      // 定义地理坐标（经纬度）
      const lon = SuperMap3D.Math.toDegrees(cartographic.longitude) // 经度
      const lat = SuperMap3D.Math.toDegrees(cartographic.latitude) // 纬度

      // 定义坐标系
      const projectionFrom = 'EPSG:4326'; // WGS 84 坐标系（经纬度）
      const projectionTo = 'EPSG:4490'; // GCJ-02 坐标系（中国大地坐标系2000）

      // 定义坐标转换
      proj4.defs(projectionTo, '+proj=longlat +ellps=GRS80 +no_defs');

      // 使用Proj4js进行转换
      const transformedCoordinates = proj4(projectionFrom, projectionTo, [lon, lat]);

      console.log('Transformed Coordinates:', transformedCoordinates);

      // return [lon, lat]
      return transformedCoordinates
    })

    console.log(coordinates);


    const queryObj = {
      f: "json",
      geometry: JSON.stringify({ "spatialReference": { "wkid": 4490 }, "rings": [coordinates] }),
      outFields: "*",
      returnGeometry: false,
      spatialRel: "esriSpatialRelIntersects",
      where: "1 = 1",
      geometryType: "esriGeometryPolygon",
      inSR: 4490,
    };
    const paramsJson = JSON.stringify(queryObj)
    console.log(queryObj);

    $.ajax({
      type: "get",
      url: "http://192.168.1.181:16080/arcgis/rest/services/LZ/LZ_GLSJ/MapServer/0/query",
      data: queryObj,
      success: function (result) {
        const resultObj = JSON.parse(result);
        console.log(resultObj);
      },
      error: function (msg) {
        console.log(msg);
      }
    })
  }
</script>

</html>