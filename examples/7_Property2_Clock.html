<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Property案例和时钟</title>
  <link href="../lib/Build/SuperMap3D/Widgets/widgets.css" rel="stylesheet">
  <link rel="stylesheet" href="../lib/css/pretty.css">
  <link rel="stylesheet" href="../lib/css/bootstrap.min.css">
  <script type="text/javascript" src="../lib/js/tooltip.js"></script>
  <script type="text/javascript" src="../lib/js/jquery.min.js"></script>
  <script type="text/javascript" src="../lib/Build/SuperMap3D/SuperMap3D.js"></script>
  <script type="text/javascript" src="../lib/js/config.js"></script>
  <style>
    body {
      position: relative;

    }

    .operation {
      position: absolute;
      top: 0;
      left: 0;
      z-index: 1;
    }

    #Container {
      background-size: cover;
      width: 100%;
      height: 100%;
    }
  </style>
</head>

<body>
  <div class="operation">
    <button id="rotateEntity" class="button black">圆形旋转</button>
    <button id="airplane" class="button black">飞机飞行</button>
    <button id="CurrentTime" class="button black">当前时间</button>
    <button id="setTime" class="button black">设置时间</button>
    <button id="formatTime" class="button black">Animation显示当前系统时间</button>
    <!-- <button id="tickStop" class="button black">tickStop</button> -->
  </div>
  <div id="Container"></div>
</body>

<script>
  let viewer = null
  let scene = null
  let camera = null
  let ellipsoid = null
  let tickId = null

  function onload(SuperMap3D) {
    viewer = new SuperMap3D.Viewer('Container', {
      // 取消信息提示框
      infoBox: false,
      timeline: true,
      animation: true, // clock采用儒略日时间,与北京时间有8个小时时差
      shouldAnimate: true,
    });
    scene = viewer.scene;
    camera = viewer.camera;
    scene.globe.depthTestAgainstTerrain = false; // 取消深度测试

    // 监听每一帧变化
    // function tick() {
    //   console.log(viewer.clock.currentTime);
    //   tickId = SuperMap3D.requestAnimationFrame(tick);
    // }
    // tick();
  }
  onload(SuperMap3D);

  $("#rotateEntity").click(() => {
    let _rotation = 0
    const _amount = 1
    const ellipse = viewer.entities.add({
      id: 'ellipse',
      name: "ellipse",
      position: SuperMap3D.Cartesian3.fromDegrees(113.9236839, 22.528061),
      ellipse: {
        semiMinorAxis: 1000,
        semiMajorAxis: 1000,
        material: new SuperMap3D.ImageMaterialProperty({
          image: "../assets/background.jpg",
          repeat: new SuperMap3D.Cartesian2(1, 1) // x,y方向重复的次数
        }),
        // 设置材质旋转
        stRotation: new SuperMap3D.CallbackProperty(function () {
          _rotation += _amount;
          if (_rotation >= 360 || _rotation <= -360) {
            _stRotation = 0;
          }
          return SuperMap3D.Math.toRadians(_rotation);
        }, false)
      }
    })
    viewer.flyTo(ellipse)
  })

  // 飞机飞行
  $("#airplane").click(() => {
    const start = SuperMap3D.JulianDate.now()
    const stop = SuperMap3D.JulianDate.addSeconds(
      start,
      360,
      new SuperMap3D.JulianDate()
    );

    setClock(start, stop)

    const position = computeRingFlight(-112.110693, 36.0994841, 0.03, start)
    const entities = viewer.entities.add({
      position,
      // 实体方向----根据所提供 PositionProperty 的速度计算为 Quaternion 旋转
      orientation: new SuperMap3D.VelocityOrientationProperty(position),
      // 将实体可用性设置为与模拟时间相同的间隔。设置entity可用范围
      availability: new SuperMap3D.TimeIntervalCollection([
        new SuperMap3D.TimeInterval({
          start: start,
          stop: stop,
        }),
      ]),
      // 模型对象
      model: {
        uri: "../SampleData/models/SuperMap3D_Air.glb",
        // uri: "../SampleData/gltf/客机模型/客机模型.gltf",
        minimumPixelSize: 64,
      },
      // 路径
      path: {
        resolution: 1,
        material: new SuperMap3D.PolylineGlowMaterialProperty({
          glowPower: 0.1,
          color: SuperMap3D.Color.YELLOW,
        }),
        width: 10,
      },
    })
  })

  /**
     * @description: 设置时钟,保证在所需时间观看
     * @param {JulianDate} start 动画开始时间
     * @param {JulianDate} stop 动画结束时间
     * @param {boolean} isLoop 动画是否循环
     * @return {*}
     */
  function setClock(start, stop, isLoop = true) {

    viewer.clock.startTime = start
    viewer.clock.currentTime = start
    viewer.clock.stopTime = stop
    viewer.clock.multiplier = 10 //设置倍速 正数是正向(前进)加速  负数数是反向(回退)加速 
    if (isLoop) {
      viewer.clock.clockRange = SuperMap3D.ClockRange.LOOP_STOP // 到达clock.stopTime后"时间倒流"
      // viewer.clock.clockRange = SuperMap3D.ClockRange.CLAMPED // 到达clock.stopTime后"时间停止"
      // viewer.clock.clockRange = SuperMap3D.ClockRange.UNBOUNDED // 到达clock.stopTime后"时间继续"
    }
    // 将时间设置到可见范围
    viewer.timeline.zoomTo(start, stop)
  }

  /**
   * @description: 计算环形飞行路线
   * @param {*} lon 经度
   * @param {*} lat 维度
   * @param {*} radius 半径
   * @param {*} start 开始时间
   * @return {*} 飞行路线Property
   */
  function computeRingFlight(lon, lat, radius, start) {
    const points = []
    const property = new SuperMap3D.SampledPositionProperty()
    for (let i = 0; i <= 360; i += 45) {
      // 角度转弧度
      const radians = SuperMap3D.Math.toRadians(i);
      const time = SuperMap3D.JulianDate.addSeconds(
        start,
        i,
        new SuperMap3D.JulianDate()
      );
      // 计算位置
      const position = SuperMap3D.Cartesian3.fromDegrees(
        lon + radius * 1.5 * Math.cos(radians),
        lat + radius * Math.sin(radians),
        SuperMap3D.Math.nextRandomNumber() * 500 + 1750
      );
      property.addSample(time, position);

      const point = viewer.entities.add({
        position,
        point: {
          pixelSize: 8,
          color: SuperMap3D.Color.AQUAMARINE,
          outlineColor: SuperMap3D.Color.YELLOW,
          outlineWidth: 3,
        }
      })
      points.push(point)
    }
    viewer.flyTo(points)
    return property
  }

  $("#CurrentTime").click(() => {
    console.log("当前儒略日时间", viewer.clock.currentTime);
  })

  $("#setTime").click(() => {
    //设定起始时间
    const start = SuperMap3D.JulianDate.now()
    //设定终止时间
    const stop = SuperMap3D.JulianDate.addSeconds(
      start,
      360,
      new SuperMap3D.JulianDate()
    );
    // 将视图设置为提供的时间,若为设置则是展示当天的时间--24小时
    viewer.timeline.zoomTo(start, stop);
    //定义clock事件
    let clock = viewer.clock;
    //设定clock的起始时间
    clock.startTime = start;
    //设定clock的终止时间
    clock.endTime = stop;
    //设定clock的当前时间
    clock.currentTime.start;
    //设定clock范围为不断循环
    clock.clockRange = SuperMap3D.ClockRange.LOOP_STOP;
    //设定时间速率
    clock.multiplier = 20; // 设置倍速 正数是正向(前进)加速  负数数是反向(回退)加速 若设置为86400，表示真实世界经过1秒，而在Cesium中时钟经过1天

  })

  /**
   * @description: Animation显示当前系统时间
   * @return {*}
   */
  $("#formatTime").click(() => {
    viewer.animation.viewModel.timeFormatter = (data, viewModel) => {
      const julianDate_now = SuperMap3D.JulianDate.now()
      const now = new Date()
      // 返回协调世界时（UTC）相对于当前时区的时间差值，单位为分钟。
      const minutes = 0 - now.getTimezoneOffset()
      // 增加时差后的JulianDate
      const dataZone8 = SuperMap3D.JulianDate.addMinutes(julianDate_now, minutes, new SuperMap3D.JulianDate())

      const gregorianDate = SuperMap3D.JulianDate.toGregorianDate(dataZone8, new SuperMap3D.JulianDate())

      const millisecond = Math.round(gregorianDate.millisecond);

      if (Math.abs(viewModel._clockViewModel.multiplier) < 1) {
        return SuperMap3D.sprintf("%02d:%02d:%02d.%03d;", gregorianDate.hour, gregorianDate.minute, gregorianDate.second);
      }
      return SuperMap3D.sprintf("%02d:%02d:%02d GMT+8", gregorianDate.hour, gregorianDate.minute, gregorianDate.second);
    }
  })

  // $("#tickStop").click(() => {
  //   if (tickId) {
  //     SuperMap3D.cancelAnimationFrame(tickId);
  //     tickId = null
  //   }
  // })
</script>

</html>